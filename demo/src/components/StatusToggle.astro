---
// StatusToggle.astro
export interface Props {
  status: 'online' | 'away' | 'offline';
  username: string;
}

const { status, username } = Astro.props;

const statusConfig = {
  online: { color: 'success', icon: 'üü¢', text: 'Online' },
  away: { color: 'warning', icon: 'üü°', text: 'Away' },
  offline: { color: 'error', icon: 'üî¥', text: 'Offline' }
};

const nextStatus = status === 'online' ? 'away' : status === 'away' ? 'offline' : 'online';
const nextConfig = statusConfig[nextStatus];

// Template variables for better organization and reusability
const optimisticTemplate = `
  <div class="status-card hx-optimistic card bg-base-100 shadow-md border-2 border-blue-400">
    <div class="card-body p-4">
      <div class="flex items-center gap-3">
        <div class="avatar placeholder">
          <div class="bg-neutral text-neutral-content rounded-full w-12">
            <span class="text-xl">${username.charAt(0).toUpperCase()}</span>
          </div>
        </div>
        <div class="flex-1">
          <h3 class="font-semibold">${username}</h3>
          <div class="flex items-center gap-2">
            <span class="text-lg">${nextConfig.icon}</span>
            <span class="badge badge-${nextConfig.color}">${nextConfig.text}</span>
          </div>
        </div>
        <button class="btn btn-outline btn-sm">Change Status</button>
      </div>
    </div>
  </div>
`;

const errorTemplate = `
  <div class="status-card card bg-base-100 shadow-md border-2 border-red-400">
    <div class="card-body p-4">
      <div class="flex items-center gap-3">
        <div class="avatar placeholder">
          <div class="bg-neutral text-neutral-content rounded-full w-12">
            <span class="text-xl">${username.charAt(0).toUpperCase()}</span>
          </div>
        </div>
        <div class="flex-1">
          <h3 class="font-semibold">${username}</h3>
          <div class="flex items-center gap-2">
            <span class="text-lg">‚ùå</span>
            <span class="badge badge-error">Failed to update status</span>
          </div>
        </div>
      </div>
    </div>
  </div>
`;

const optimisticConfig = {
  snapshotContent: true,
  template: optimisticTemplate,
  errorTemplate: errorTemplate,
  delay: 2500,
};
---

<div class="status-card card bg-base-100 shadow-md border-2 border-base-300">
  <div class="card-body p-4">
    <div class="flex items-center gap-3">
      <div class="avatar placeholder">
        <div class="bg-neutral text-neutral-content rounded-full w-12">
          <span class="text-xl">{username.charAt(0).toUpperCase()}</span>
        </div>
      </div>
      <div class="flex-1">
        <h3 class="font-semibold">{username}</h3>
        <div class="flex items-center gap-2">
          <span class="text-lg">{statusConfig[status].icon}</span>
          <span class={`badge badge-${statusConfig[status].color}`}>
            {statusConfig[status].text}
          </span>
        </div>
      </div>
      <button
        class="btn btn-outline btn-sm"
        hx-post="/api/status"
        hx-target="closest .status-card"
        hx-swap="outerHTML"
        hx-vals={JSON.stringify({ 
          username: username,
          currentStatus: status, 
          newStatus: nextStatus 
        })}
        hx-ext="optimistic"
        data-optimistic={JSON.stringify(optimisticConfig)}
      >
        Change Status
      </button>
    </div>
  </div>
</div>
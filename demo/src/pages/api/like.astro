---
import LikeButton from "../../components/LikeButton.astro";

// Parse form data to get current state
const formData = await Astro.request.formData();
const currentLiked = formData.get("liked") === "true";
const currentCount = parseInt(formData.get("count") as string) || 42;

// Simulate some processing time
await new Promise((resolve) =>
  setTimeout(resolve, Math.random() * 500 + 200),
);

// Simulate occasional errors (20% chance)
if (Math.random() < 0.2) {
  return new Response("Server Error", { status: 500 });
}

// Toggle the state
const newLiked = !currentLiked;
const newCount = newLiked ? currentCount + 1 : currentCount - 1;

// Set response headers for HTMX
Astro.response.headers.set("Content-Type", "text/html");
---

<LikeButton liked={newLiked} count={newCount} />
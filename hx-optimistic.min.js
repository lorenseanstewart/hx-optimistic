/**
 * HTMX Optimistic Updates Extension
 * 
 * Provides optimistic UI updates with automatic rollback on errors.
 * No CSS included - you control all styling through the provided class names.
 * 
 * @version 1.0.0
 * @license MIT
 */
!function(){"use strict";function t(){const t=new WeakMap,e=new WeakMap,r=new WeakMap;function n(t,e,r={}){return"string"!=typeof t?t:t.replace(/\${([^}]+)}/g,(t,n)=>{if(n=n.trim(),void 0!==r[n])return r[n];if("this.value"===n&&e&&void 0!==e.value)return e.value;if(n.startsWith("this.dataset.")&&e){const r=n.slice(13);return e.dataset[r]||t}if("this.textContent"===n&&e)return e.textContent||t;if(n.startsWith("attr:")&&e){const r=n.slice(5);return e.getAttribute(r)||t}if(n.startsWith("data:")&&e){const r=n.slice(5);return e.dataset[r]||t}if(n.includes("Math.")||n.includes("count"))try{const t=function(t,e){const r=e?.dataset?.count||"0";t=t.replace(/\bcount\b/g,r);const n=function(t){const e=[];let r=0;for(;r<t.length;){const n=t[r];if(/\s/.test(n))r++;else if(/\d/.test(n)){let n="";for(;r<t.length&&/[\d.]/.test(t[r]);)n+=t[r],r++;e.push({type:"number",value:parseFloat(n)})}else if("Math.max"===t.substr(r,8))e.push({type:"function",value:"max"}),r+=8;else if("Math.min"===t.substr(r,8))e.push({type:"function",value:"min"}),r+=8;else if("+-*/()".includes(n))e.push({type:"operator",value:n}),r++;else{if(","!==n)return null;e.push({type:"comma",value:","}),r++}}return e}(t);return n?function(t){let e=0;function r(){return t[e]}function n(r){const n=t[e];if(!n||n.type!==r)throw new Error(`Expected ${r}, got ${n?.type||"EOF"}`);return e++,n}function i(){let t=s();for(;r()&&"operator"===r().type&&"+-".includes(r().value);){const e=n("operator").value,r=s();t="+"===e?t+r:t-r}return t}function s(){let t=o();for(;r()&&"operator"===r().type&&"*/".includes(r().value);){const e=n("operator").value,r=o();t="*"===e?t*r:t/r}return t}function o(){const t=r();if(!t)throw new Error("Unexpected end of expression");if("number"===t.type)return n("number"),t.value;if("operator"===t.type&&"("===t.value){n("operator");const t=i();return n("operator"),t}if("function"===t.type){const t=n("function").value;n("operator");const e=[];if(r()&&("operator"!==r().type||")"!==r().value))for(e.push(i());r()&&"comma"===r().type;)n("comma"),e.push(i());if(n("operator"),"max"===t)return Math.max(...e);if("min"===t)return Math.min(...e)}throw new Error(`Unexpected token: ${t.type} ${t.value}`)}try{const r=i();return e===t.length?r:null}catch(t){return null}}(n):null}(n,e);if(null!==t)return t}catch(t){}return(n.includes(".")||n.includes(":"))&&console.warn(`[hx-optimistic] Unresolved interpolation pattern: \${${n}}`,"\nSupported patterns:","\n  ${this.value} - element value","\n  ${this.textContent} - element text content","\n  ${this.dataset.key} - data attribute","\n  ${data:key} - data attribute shorthand","\n  ${attr:name} - any attribute","\n  ${Math.max(0, count)} - arithmetic with count","\n  ${status}, ${statusText}, ${error} - error context","\nSee documentation for details."),t})}function i(t,e,r=!1){if(!t)return null;if(r&&e?.detail?.target)return e.detail.target;const n=t.getAttribute("hx-target");if(n&&"this"!==n){if(n.startsWith("closest ")){const e=n.slice(8);return t.closest(e)}if(n.startsWith("find ")){const e=n.slice(5);return t.querySelector(e)}if(n.startsWith("next ")){const e=n.slice(5);let r=t.nextElementSibling;for(;r;){if(r.matches(e))return r;r=r.nextElementSibling}return null}if(n.startsWith("previous ")){const e=n.slice(9);let r=t.previousElementSibling;for(;r;){if(r.matches(e))return r;r=r.previousElementSibling}return null}return document.querySelector(n)}return t}function s(t,e){if(t&&t.classList)switch(t.classList.remove("hx-optimistic","hx-optimistic-error","hx-optimistic-reverting"),e){case"optimistic":t.classList.add("hx-optimistic");break;case"error":t.classList.add("hx-optimistic-error");break;case"reverting":t.classList.add("hx-optimistic-reverting")}}function o(e){if(!e?.dataset?.optimistic)return null;if(t.has(e))return t.get(e);let r;const n=e.dataset.optimistic;try{"true"===n||""===n?r={}:(r=JSON.parse(n),"object"==typeof r&&null!==r||(r={values:{textContent:n}}))}catch(t){r={values:{textContent:n}}}r.optimisticTemplate&&(r.template=r.optimisticTemplate,delete r.optimisticTemplate),r.errorTarget&&(r.errorMode=r.errorTarget,delete r.errorTarget),void 0!==r.revertDelay&&(r.delay=r.revertDelay,delete r.revertDelay);const i=e.tagName.toLowerCase(),s=e.type;return r.values||r.template||("input"===i&&["text","email","password"].includes(s)?r.values={textContent:"${this.value}",className:(e.className+" optimistic-pending").trim()}:r.values="textarea"===i?{textContent:"${this.value}",className:(e.className+" optimistic-pending").trim()}:"button"===i?{textContent:r.loadingText||"Loading...",className:(e.className+" optimistic-pending").trim()}:{className:(e.className+" optimistic-pending").trim()}),r.errorMessage=r.errorMessage||"Request failed",r.delay=void 0!==r.delay?r.delay:2e3,r.errorMode=r.errorMode||"replace",t.set(e,r),r}htmx.defineExtension("optimistic",{onEvent:function(t,e){const r={"htmx:beforeRequest":this.handleBeforeRequest,"htmx:responseError":this.handleError,"htmx:swapError":this.handleError,"htmx:timeout":this.handleError,"htmx:sendError":this.handleError,"htmx:afterSwap":this.handleAfterSwap}[t];r&&r.call(this,e)},handleBeforeRequest:function(t){const e=t.target;if(!e?.dataset?.optimistic)return;if(!o(e))return;const n=i(e,t,!1);if(!n)return void console.warn("[hx-optimistic] Target element not found for:",e);const a=(r.get(n)||0)+1;r.set(n,a),this.snapshot(n,e,a),this.applyOptimistic(n,e),s(n,"optimistic")},handleError:function(t){const n=t.detail?.elt||t.target,a=i(n,t,!0);if(!a)return;const c=e.get(a),l=c?.config||o(n);if(!l)return;const u=r.get(a);if(c&&c.token!==u)return;s(a,"error"),this.showError(a,l,t);const p=void 0!==l.delay?l.delay:1500;p>0&&setTimeout(()=>this.revertOptimistic(a,u),p)},handleAfterSwap:function(t){this.precisionCleanup(t.target)},showError:function(t,e,r){if(!t.dataset.hxOptimisticErrorShown)if(t.dataset.hxOptimisticErrorShown="true",e.errorTemplate){const i=this.getTemplate(e.errorTemplate);if(i){const s={status:r.detail?.xhr?.status||0,statusText:r.detail?.xhr?.statusText||"Network Error",error:r.detail?.error||"Request failed"};if("append"===e.errorMode){const e=document.createElement("div");e.className="hx-optimistic-error-message",e.innerHTML=n(i,t,s),t.appendChild(e)}else t.innerHTML=n(i,t,s)}}else if(e.errorMessage)if("append"===e.errorMode){const r=document.createElement("div");r.className="hx-optimistic-error-message",r.textContent=e.errorMessage,t.appendChild(r)}else t.textContent=e.errorMessage},snapshot:function(t,r,n){if(!t)return;const i=o(r=r||t);if(!i)return;const s={innerHTML:t.innerHTML,className:t.className,sourceElement:r,config:i,token:n};i.snapshot&&i.snapshot.includes("textContent")&&(s.textContent=t.textContent),i.snapshotContent&&(s.fullContent=t.outerHTML),e.set(t,s)},applyOptimistic:function(t,r){if(r=r||t,!t||!r)return;const i=o(r);if(i)if(i.template){const s=this.getTemplate(i.template);if(s){if(t!==r){const n=e.get(r);n&&e.set(t,n)}t.innerHTML=n(s,r)}}else i.values&&this.applyValues(t,i.values,r)},revertOptimistic:function(t,n){if(!t)return;const i=e.get(t);if(i&&(void 0===n||i.token===n)){if(s(t,"reverting"),void 0!==i.fullContent){const e=document.createElement("div");e.innerHTML=i.fullContent;const r=e.firstElementChild;if(r&&t.parentNode)return t.parentNode.replaceChild(r,t),void("undefined"!=typeof htmx&&htmx.process&&htmx.process(r))}void 0!==i.innerHTML&&(t.innerHTML=i.innerHTML),void 0!==i.className&&(t.className=i.className),void 0!==i.textContent&&(t.textContent=i.textContent),e.delete(t),r.delete(t),"undefined"!=typeof htmx&&htmx.process&&htmx.process(t),this.cleanup(t)}},cleanup:function(t){if(!t)return;s(t,"clean");t.querySelectorAll(".hx-optimistic-error-message").forEach(t=>t.remove()),t.dataset&&Object.keys(t.dataset).filter(t=>t.startsWith("hxOptimistic")).forEach(e=>delete t.dataset[e])},precisionCleanup:function(t){if(!t)return;this.cleanup(t);t.querySelectorAll(".optimistic-pending, .hx-optimistic, .hx-optimistic-error, .hx-optimistic-reverting").forEach(t=>{s(t,"clean")})},getTemplate:function(t){if(t.startsWith("#")){const e=document.querySelector(t);return e?e.innerHTML:null}return t},applyValues:function(t,e,r){r=r||t,Object.entries(e).forEach(([e,i])=>{const s=n(i,r);"textContent"===e?t.textContent=s:"innerHTML"===e?t.innerHTML=s:"className"===e?t.className=s:e.startsWith("data-")?t.dataset[e.slice(5)]=s:t[e]=s})}})}"undefined"!=typeof htmx?t():"loading"===document.readyState&&document.addEventListener("DOMContentLoaded",function(){"undefined"!=typeof htmx&&t()})}();
/**
 * HTMX Optimistic Updates Extension
 * 
 * Provides optimistic UI updates with automatic rollback on errors.
 * No CSS included - you control all styling through the provided class names.
 * 
 * @version 1.0.0
 * @license MIT
 */
!function(){"use strict";function t(){htmx.defineExtension("optimistic",{onEvent:function(t,e){const i=e.target;if(!new Set(["htmx:beforeRequest","htmx:responseError","htmx:swapError","htmx:timeout","htmx:sendError","htmx:afterSwap"]).has(t))return;if("htmx:afterSwap"===t)return void this.precisionCleanup(e.target);if(!i.dataset.optimistic)return;this.enhanceConfig(i);const s=i.getAttribute("hx-target");let a;if(s&&"this"!==s)if(s.startsWith("closest ")){const t=s.slice(8);a=i.closest(t)}else a=document.querySelector(s);else a=i;switch(t){case"htmx:beforeRequest":if(!a)return void console.warn("[hx-optimistic] Target element not found for:",i);const t=parseInt(a.dataset.hxOptimisticToken||"0",10)+1;a.dataset.hxOptimisticToken=t,i.dataset.hxOptimisticRequestToken=t,this.snapshot(a),this.applyOptimistic(a,i),a.dataset&&(a.dataset.hxOptimisticSource=i.id||Math.random().toString(),i.id||(i.id=a.dataset.hxOptimisticSource));break;case"htmx:responseError":case"htmx:swapError":case"htmx:timeout":case"htmx:sendError":const s=i.dataset.hxOptimisticRequestToken,r=a?.dataset?.hxOptimisticToken;if(s!==r)return;const n=a?.dataset?.hxOptimisticSource,o=n?document.getElementById(n):i;o&&o.dataset&&o.dataset.optimistic&&this.handleError(a,e,o)}},snapshot:function(t){if(!t||!t.dataset)return;const e=this.getConfig(t);e&&(t.dataset.hxOptimisticInnerHTML=t.innerHTML,t.dataset.hxOptimisticClassName=t.className,e.snapshot&&e.snapshot.includes("textContent")&&(t.dataset.hxOptimisticTextContent=t.textContent))},applyOptimistic:function(t,e){if(e=e||t,!t||!e)return;const i=this.getConfig(e);if(i){if(i.optimisticTemplate){const s=this.getTemplate(i.optimisticTemplate);s&&(t.innerHTML=this.renderTemplate(s,e))}else i.values&&this.applyValues(t,i.values,e);t.classList.add(i.class||"hx-optimistic")}},handleError:function(t,e,i){if(i=i||t,!t||!i)return;const s=this.getConfig(i);if(!s)return;if(t.classList&&(t.classList.remove("hx-optimistic"),t.classList.add("hx-optimistic-error")),!t.dataset.hxOptimisticErrorShown)if(t.dataset.hxOptimisticErrorShown="true",s.errorTemplate){const i=this.getTemplate(s.errorTemplate);if(i){const a={status:e.detail?.xhr?.status||0,statusText:e.detail?.xhr?.statusText||"Network Error",error:e.detail?.error||"Request failed"};if("append"===s.errorTarget){const e=document.createElement("div");e.className="hx-optimistic-error-message",e.innerHTML=this.renderTemplate(i,t,a),t.appendChild(e)}else t.innerHTML=this.renderTemplate(i,t,a)}}else if(s.errorMessage)if("append"===s.errorTarget){const e=document.createElement("div");e.className="hx-optimistic-error-message",e.textContent=s.errorMessage,t.appendChild(e)}else t.textContent=s.errorMessage;const a=void 0!==s.revertDelay?s.revertDelay:1500;a>0&&setTimeout(()=>this.revertOptimistic(t),a)},revertOptimistic:function(t){if(!t)return;t.classList.add("hx-optimistic-reverting"),void 0!==t.dataset.hxOptimisticInnerHTML&&(t.innerHTML=t.dataset.hxOptimisticInnerHTML,delete t.dataset.hxOptimisticInnerHTML),void 0!==t.dataset.hxOptimisticClassName&&(t.className=t.dataset.hxOptimisticClassName,delete t.dataset.hxOptimisticClassName),void 0!==t.dataset.hxOptimisticTextContent&&(t.textContent=t.dataset.hxOptimisticTextContent,delete t.dataset.hxOptimisticTextContent),Object.keys(t.dataset).filter(t=>t.startsWith("hxOptimistic")).forEach(e=>delete t.dataset[e]),t.classList.remove("hx-optimistic","hx-optimistic-error","hx-optimistic-reverting");const e=t.querySelector(".hx-optimistic-error-message");e&&e.remove()},precisionCleanup:function(t){if(!t)return;t.classList&&t.classList.remove("hx-optimistic","hx-optimistic-error","optimistic-pending");t.querySelectorAll(".optimistic-pending, .hx-optimistic, .hx-optimistic-error").forEach(t=>{t.classList.remove("optimistic-pending","hx-optimistic","hx-optimistic-error")}),t.dataset&&Object.keys(t.dataset).filter(t=>t.startsWith("hxOptimistic")).forEach(e=>delete t.dataset[e])},enhanceConfig:function(t){let e;try{e=t.dataset.optimistic?JSON.parse(t.dataset.optimistic):{}}catch(i){const s=t.dataset.optimistic;e="true"===s||""===s?{}:{values:{textContent:s}}}const i=t.tagName.toLowerCase(),s=t.type;if("input"!==i||"text"!==s&&"email"!==s&&"password"!==s)"textarea"===i?e.values||e.optimisticTemplate||(e.values=e.values||{textContent:"${this.value}",className:(t.className+" optimistic-pending").trim()}):"button"===i?e.values||e.optimisticTemplate||(e.values=e.values||{textContent:e.loadingText||"Loading...",className:(t.className+" optimistic-pending").trim()}):e.values||e.optimisticTemplate||(e.values=e.values||{className:(t.className+" optimistic-pending").trim()});else if(!e.values&&!e.optimisticTemplate){const i=t.getAttribute("hx-target"),s=i&&i.includes("display");e.values=s?e.values||{textContent:"${this.value}",className:"optimistic-pending"}:e.values||{textContent:"${this.value}",className:(t.className+" optimistic-pending").trim()}}if(e.errorMessage=e.errorMessage||"Request failed",e.revertDelay=void 0!==e.revertDelay?e.revertDelay:2e3,!t.getAttribute("hx-target")&&("input"===i||"textarea"===i)){const e=t.previousElementSibling||t.nextElementSibling;e&&(e.classList.contains("display-text")||e.classList.contains("display")||e.classList.contains("value"))?t.previousElementSibling&&t.previousElementSibling.classList.contains("display-text")?t.setAttribute("hx-target","previous .display-text"):t.nextElementSibling&&t.nextElementSibling.classList.contains("display-text")?t.setAttribute("hx-target","next .display-text"):t.setAttribute("hx-target","previous .display, next .display, previous .value, next .value"):t.setAttribute("hx-target","this")}t.dataset.optimistic=JSON.stringify(e)},getConfig:function(t){if(!t||!t.dataset||!t.dataset.optimistic)return null;try{return JSON.parse(t.dataset.optimistic)}catch(t){return null}},getTemplate:function(t){if(t.startsWith("#")){const e=document.querySelector(t);return e?e.innerHTML:null}return t},renderTemplate:function(t,e,i){return i=i||{},t.replace(/\${([^}]+)}/g,(t,s)=>{if(s=s.trim(),void 0!==i[s])return i[s];if("this.value"===s&&void 0!==e.value)return e.value;if(s.startsWith("this.dataset.")){const i=s.slice(13);return e.dataset[i]||t}return t})},applyValues:function(t,e,i){i=i||t,Object.entries(e).forEach(([e,s])=>{const a=this.evaluateValue(s,i);"textContent"===e?t.textContent=a:"innerHTML"===e?t.innerHTML=a:"className"===e?t.className=a:e.startsWith("data-")?t.dataset[e.slice(5)]=a:t[e]=a})},evaluateValue:function(t,e){return"string"!=typeof t?t:t.includes("${")?t.replace(/\${([^}]+)}/g,(t,i)=>{if("this.value"===(i=i.trim())&&void 0!==e.value)return e.value;if(i.startsWith("this.dataset.")){const s=i.slice(13);return e.dataset[s]||t}return t}):t}})}"undefined"!=typeof htmx?t():"loading"===document.readyState&&document.addEventListener("DOMContentLoaded",function(){"undefined"!=typeof htmx&&t()})}();
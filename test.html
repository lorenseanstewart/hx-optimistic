<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>hx-optimistic Test Suite</title>
  
  <!-- Test Framework -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mocha/9.2.2/mocha.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mocha/9.2.2/mocha.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chai/4.3.7/chai.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sinon.js/15.2.0/sinon.min.js"></script>
  
  <!-- HTMX -->
  <script src="https://unpkg.com/htmx.org@1.9.10/dist/htmx.min.js"></script>
  
  <!-- Extension under test -->
  <script src="./hx-optimistic.js"></script>
  
  <!-- Suppress HTMX console logs during testing -->
  <script>
    // Reduce HTMX console noise during tests
    htmx.config.defaultSwapStyle = 'innerHTML';
    htmx.config.defaultSwapDelay = 0;
    htmx.config.requestClass = 'htmx-request';
  </script>
  
  <style>
    #test-container {
      display: none;
    }
    
    .hx-optimistic {
      background: yellow;
    }
    
    .hx-optimistic-error {
      background: red;
      color: white;
    }
    
    .hx-optimistic-reverting {
      opacity: 0.5;
    }
  </style>
</head>
<body>
  <div id="mocha"></div>
  <div id="test-container"></div>
  
  <!-- Test templates -->
  <template id="test-loading-template">
    <div class="loading">Loading...</div>
  </template>
  
  <template id="test-error-template">
    <div class="error">Error ${status}: ${statusText}</div>
  </template>
  
  <script>
    // Wait for all scripts to load
    window.addEventListener('load', function() {
      // Setup Mocha after everything loads
      mocha.setup('bdd');
      
      // Initialize test framework
      const expect = chai.expect;
      let container;
      let server;
      
      describe('hx-optimistic Extension', function() {
        
        beforeEach(function() {
          container = document.getElementById('test-container');
          container.innerHTML = '';
          // Setup fake server for AJAX requests
          server = sinon.createFakeServer();
          server.respondImmediately = false;
        });
        
        afterEach(function() {
          server.restore();
          container.innerHTML = '';
        });
        
        describe('Basic Optimistic Updates', function() {
          it('should apply optimistic class on request', function(done) {
            container.innerHTML = `
              <button hx-post="/api/test"
                      hx-ext="optimistic"
                      data-optimistic='{"values": {"textContent": "Loading..."}}'
                      id="test-btn">
                Click me
              </button>
            `;
            
            const btn = document.getElementById('test-btn');
            htmx.process(btn);
            
            // Trigger request
            btn.click();
            
            setTimeout(() => {
              expect(btn.classList.contains('hx-optimistic')).to.be.true;
              expect(btn.textContent).to.equal('Loading...');
              done();
            }, 10);
          });
          
          it('should snapshot original values', function(done) {
            container.innerHTML = `<button hx-post="/api/test" hx-ext="optimistic" data-optimistic='{"snapshot": ["textContent"], "values": {"textContent": "Loading..."}}' id="test-btn">Original Text</button>`;
            
            const btn = document.getElementById('test-btn');
            htmx.process(btn);
            
            // Setup server to prevent actual request
            server.respondWith('POST', '/api/test', [200, {}, 'OK']);
            
            btn.click();
            
            setTimeout(() => {
              try {
                expect(btn.dataset.hxOptimisticTextContent).to.equal('Original Text');
                done();
              } catch (e) {
                done(e);
              }
            }, 50);
          });
          
          it('should remove optimistic class on success', function(done) {
            container.innerHTML = `
              <button hx-post="/api/test"
                      hx-ext="optimistic"
                      hx-swap="innerHTML"
                      data-optimistic='{"values": {"textContent": "Loading..."}}'
                      id="test-btn">
                Click me
              </button>
            `;
            
            const btn = document.getElementById('test-btn');
            htmx.process(btn);
            
            server.respondWith('POST', '/api/test', [
              200,
              { 'Content-Type': 'text/html' },
              'Success!'
            ]);
            
            btn.click();
            
            setTimeout(() => {
              server.respond();
              setTimeout(() => {
                expect(btn.classList.contains('hx-optimistic')).to.be.false;
                expect(btn.textContent).to.equal('Success!');
                done();
              }, 50);
            }, 10);
          });
        });
        
        describe('Error Handling', function() {
          it('should apply error class on failure', function(done) {
            container.innerHTML = `
              <button hx-post="/api/test"
                      hx-ext="optimistic"
                      data-optimistic='{"errorMessage": "Failed", "revertDelay": 100}'
                      id="test-btn">
                Click me
              </button>
            `;
            
            const btn = document.getElementById('test-btn');
            htmx.process(btn);
            
            server.respondWith('POST', '/api/test', [
              500,
              { 'Content-Type': 'text/html' },
              'Server Error'
            ]);
            
            btn.click();
            
            setTimeout(() => {
              server.respond();
              setTimeout(() => {
                expect(btn.classList.contains('hx-optimistic-error')).to.be.true;
                expect(btn.textContent).to.equal('Failed');
                done();
              }, 50);
            }, 10);
          });
          
          it('should revert after error', function(done) {
            this.timeout(4000);
            
            container.innerHTML = `<button hx-post="/api/test" hx-ext="optimistic" data-optimistic='{"snapshot": ["textContent"], "values": {"textContent": "Loading..."}, "errorMessage": "Failed", "revertDelay": 200}' id="test-btn">Original</button>`;
            
            const btn = document.getElementById('test-btn');
            htmx.process(btn);
            
            server.respondWith('POST', '/api/test', [500, { 'Content-Type': 'text/plain' }, 'Server Error']);
            
            btn.click();
            
            setTimeout(() => {
              try {
                server.respond();
                setTimeout(() => {
                  try {
                    expect(btn.textContent).to.equal('Original');
                    expect(btn.classList.contains('hx-optimistic-error')).to.be.false;
                    done();
                  } catch (e) {
                    done(e);
                  }
                }, 400);
              } catch (e) {
                done(e);
              }
            }, 50);
          });
        });
        
        describe('Template Support', function() {
          it('should use optimistic template', function(done) {
            container.innerHTML = `
              <button hx-post="/api/test"
                      hx-ext="optimistic"
                      data-optimistic='{"optimisticTemplate": "#test-loading-template"}'
                      id="test-btn">
                Click me
              </button>
            `;
            
            const btn = document.getElementById('test-btn');
            htmx.process(btn);
            
            btn.click();
            
            setTimeout(() => {
              expect(btn.innerHTML).to.include('Loading...');
              expect(btn.querySelector('.loading')).to.exist;
              done();
            }, 10);
          });
          
          it('should use inline template string', function(done) {
            container.innerHTML = `
              <button hx-post="/api/test"
                      hx-ext="optimistic"
                      data-optimistic='{"optimisticTemplate": "<span class=\\"inline-loading\\">Wait...</span>"}'
                      id="test-btn">
                Click me
              </button>
            `;
            
            const btn = document.getElementById('test-btn');
            htmx.process(btn);
            
            btn.click();
            
            setTimeout(() => {
              expect(btn.innerHTML).to.equal('<span class="inline-loading">Wait...</span>');
              done();
            }, 10);
          });
          
          it('should render error template with variables', function(done) {
            container.innerHTML = `
              <button hx-post="/api/test"
                      hx-ext="optimistic"
                      data-optimistic='{"errorTemplate": "#test-error-template", "revertDelay": 100}'
                      id="test-btn">
                Click me
              </button>
            `;
            
            const btn = document.getElementById('test-btn');
            htmx.process(btn);
            
            server.respondWith('POST', '/api/test', [
              404,
              { 'Content-Type': 'text/html' },
              'Not Found'
            ]);
            
            btn.click();
            
            setTimeout(() => {
              server.respond();
              setTimeout(() => {
                expect(btn.innerHTML).to.include('Error 404');
                expect(btn.innerHTML).to.include('Not Found');
                done();
              }, 50);
            }, 10);
          });
        });
        
        describe('Dynamic Values', function() {
          it('should evaluate element properties', function(done) {
            container.innerHTML = `
              <button hx-post="/api/test"
                      hx-ext="optimistic"
                      data-count="5"
                      data-optimistic='{"values": {"textContent": "Count: \${this.dataset.count}"}}'
                      id="test-btn">
                Click me
              </button>
            `;
            
            const btn = document.getElementById('test-btn');
            htmx.process(btn);
            
            btn.click();
            
            setTimeout(() => {
              expect(btn.textContent).to.equal('Count: 5');
              done();
            }, 10);
          });
        });
      });
      
      // Run tests after setup
      mocha.run();
    });
  </script>
</body>
</html>